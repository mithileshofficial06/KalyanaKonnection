{% extends "dashboard_base.html" %}

{% block sidebar %}
<div class="sidebar-section-title">ADMIN CONTROL</div>

<a href="/admin/dashboard" class="nav-item">
    <span class="nav-icon">◻</span>
    <span>Dashboard</span>
</a>
<a href="/admin/users" class="nav-item">
    <span class="nav-icon">⌘</span>
    <span>Users</span>
</a>
<a href="/admin/events" class="nav-item active">
    <span class="nav-icon">◷</span>
    <span>Events</span>
</a>
<a href="/admin/allocations" class="nav-item">
    <span class="nav-icon">⇄</span>
    <span>Allocations</span>
</a>
<a href="/admin/complaints" class="nav-item">
    <span class="nav-icon">!</span>
    <span>Complaints</span>
</a>
<a href="/admin/analytics" class="nav-item">
    <span class="nav-icon">▦</span>
    <span>Analytics</span>
</a>

<div class="sidebar-divider"></div>

<a href="/logout" class="nav-item logout-item">
    <span class="nav-icon">↩</span>
    <span>Logout</span>
</a>
{% endblock %}

{% block page_title %}Events Monitoring{% endblock %}

{% block content %}
<div class="stats-grid admin-kpi-grid">
    <div class="stat-card admin-kpi">
        <h4>Total Events Tracked</h4>
        <p>{{ event_insights.total_events }}</p>
    </div>
    <div class="stat-card admin-kpi">
        <h4>Expected Guests</h4>
        <p>{{ event_insights.total_expected_guests }}</p>
    </div>
    <div class="stat-card admin-kpi">
        <h4>Events With Surplus</h4>
        <p>{{ event_insights.events_with_surplus }}</p>
    </div>
</div>

<div class="card">
    <div class="section-header">
        <h3>Monitored Events Table</h3>
        <span class="muted">Cross-check event execution and downstream redistribution readiness</span>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Provider</th>
                <th>Event Date</th>
                <th>Guest Count</th>
                <th>Surplus Generated</th>
                <th>Allocated To</th>
                <th>Status</th>
                <th class="no-sort">View</th>
            </tr>
        </thead>
        <tbody>
            {% if events %}
                {% for item in events %}
                <tr>
                    <td>{{ item.provider.full_name if item.provider else '-' }}</td>
                    <td>{{ item.event_date.strftime('%d %b %Y') if item.event_date else '-' }}</td>
                    <td>{{ item.guest_count or 0 }}</td>
                    <td>{{ (item.surplus_batches | sum(attribute='quantity')) if item.surplus_batches else 0 }} kg</td>
                    <td>
                        {% set allocated = namespace(name='Pending') %}
                        {% if item.surplus_batches %}
                            {% for batch in item.surplus_batches %}
                                {% if batch.allocations %}
                                    {% set latest = batch.allocations[-1] %}
                                    {% set allocated.name = latest.ngo.full_name if latest.ngo else 'NGO' %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        {{ allocated.name }}
                    </td>
                    <td>
                        {% if item.surplus_batches and (item.surplus_batches | length) > 0 %}
                            <span class="status completed">Tracked</span>
                        {% else %}
                            <span class="status active">Open</span>
                        {% endif %}
                    </td>
                    <td><span class="muted">Event #{{ item.id }}</span></td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="7">No events found.</td></tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
