{% extends "dashboard_base.html" %}

{% block sidebar %}
<div class="sidebar-section-title">NGO PANEL</div>

<a href="/ngo/dashboard" class="nav-item">
	<span class="nav-icon">◻</span>
	<span>Dashboard</span>
</a>
<a href="/ngo/nearby-surplus" class="nav-item active">
	<span class="nav-icon">◎</span>
	<span>Nearby Surplus</span>
</a>
<a href="/ngo/allocations" class="nav-item">
	<span class="nav-icon">⇄</span>
	<span>Allocations</span>
</a>
<a href="/ngo/history" class="nav-item">
	<span class="nav-icon">☰</span>
	<span>Pickup History</span>
</a>
<a href="/ngo/reviews" class="nav-item">
	<span class="nav-icon">★</span>
	<span>Reviews</span>
</a>

<div class="sidebar-divider"></div>

<a href="/logout" class="nav-item logout-item">
	<span class="nav-icon">↩</span>
	<span>Logout</span>
</a>
{% endblock %}

{% block page_title %}Nearby Surplus{% endblock %}

{% block content %}
<div class="card">
	<div class="section-header">
		<h3>Find Nearby Food</h3>
		<span class="muted">Search by your pickup location and preferred radius</span>
	</div>

	<div class="filter-panel">
		<div class="filter-panel-head">
			<span class="muted">Tip: Start with your area name and expand radius if no results appear.</span>
			<a href="{{ url_for('ngo.ngo_nearby_surplus') }}" class="clear-filter">Clear filters</a>
		</div>
		<form method="GET" class="admin-toolbar" style="margin-bottom: 0;">
			<div style="flex: 1; min-width: 220px;">
				<input type="text" name="receiver_location" id="receiver_location" list="receiver_location_suggestions" value="{{ receiver_location or '' }}" placeholder="Enter your location (e.g., Nungambakkam)" required>
				<div class="form-help">Use a locality/area name for better matching.</div>
			</div>
			<datalist id="receiver_location_suggestions"></datalist>
			<div style="min-width: 140px;">
				<input type="number" step="0.5" min="1" name="radius_km" value="{{ radius_km or 8 }}" placeholder="Radius (km)">
				<div class="form-help">Radius in km</div>
			</div>
			<button type="submit" class="auth-button" style="width:auto;">Find Nearby</button>
		</form>
	</div>

	{% if resolved_location %}
		<div class="muted" style="margin-bottom:10px;">Showing matches near: {{ resolved_location.display_name }} within {{ radius_km }} km</div>
	{% endif %}

	<div class="section-header">
		<h3>Available Batches</h3>
		<span class="muted">Only matching or nearby locations are shown</span>
	</div>

	<table class="data-table">
		<thead>
			<tr>
				<th>Event</th>
				<th>Mahal</th>
				<th>Provider</th>
				<th>Provider Phone</th>
				<th>Mahal Location</th>
				<th>Food Type</th>
				<th class="no-sort">Photo</th>
				<th>Quantity</th>
				<th>Distance</th>
				<th>Estimated Expiry</th>
				<th class="no-sort">Request</th>
			</tr>
		</thead>
		<tbody>
			{% if available_surplus %}
				{% for item in available_surplus %}
				<tr>
					<td>{{ item.event_name }}</td>
					<td>{{ item.mahal_name or '-' }}</td>
					<td>{{ item.provider_name }}</td>
					<td>{{ item.provider.phone_number if item.provider and item.provider.phone_number else '-' }}</td>
					<td>{{ item.provider_location or '-' }}</td>
					<td>{{ item.food_type }}</td>
					<td>
						{% if item.photo_path %}
							<img src="{{ url_for('auth.media_file', filename=item.photo_path) }}" alt="Food photo" class="food-thumb">
						{% else %}
							<span class="muted">No photo</span>
						{% endif %}
					</td>
					<td>{{ item.quantity if item.quantity is not none else item.quantity_kg }} kg</td>
					<td>
						{% if item.computed_distance_km is defined %}
							{{ item.computed_distance_km }} km
						{% else %}
							{{ item.distance_km if item.distance_km is not none else '-' }}{% if item.distance_km is not none %} km{% endif %}
						{% endif %}
					</td>
					<td>{{ item.estimated_expiry or '-' }}</td>
					<td>
						{% if item.photo_path and item.status == 'available' %}
							<form method="POST" action="{{ url_for('ngo.ngo_request_food', surplus_id=item.id) }}" class="inline-form">
								<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
								<button type="submit" class="btn-link">Apply for Food</button>
							</form>
						{% else %}
							<span class="muted">Unavailable</span>
						{% endif %}
					</td>
				</tr>
				{% endfor %}
			{% else %}
				<tr>
					<td colspan="11">No matching nearby surplus found. Try increasing radius.</td>
				</tr>
			{% endif %}
		</tbody>
	</table>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
	const input = document.getElementById('receiver_location');
	const list = document.getElementById('receiver_location_suggestions');
	if (!input || !list) return;

	let timer = null;
	input.addEventListener('input', () => {
		clearTimeout(timer);
		const query = input.value.trim();
		if (query.length < 3) return;

		timer = setTimeout(async () => {
			const response = await fetch(`/location/suggest?q=${encodeURIComponent(query)}`);
			if (!response.ok) return;
			const data = await response.json();
			list.innerHTML = '';
			(data.suggestions || []).forEach((label) => {
				const option = document.createElement('option');
				option.value = label;
				list.appendChild(option);
			});
		}, 300);
	});
})();
</script>
{% endblock %}
