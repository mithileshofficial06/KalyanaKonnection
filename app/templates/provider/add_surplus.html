{% extends "dashboard_base.html" %}

{% block sidebar %}
<div class="sidebar-section-title">MAIN MENU</div>

<a href="/provider/dashboard" class="nav-item">
    <span class="nav-icon">◻</span>
    <span>Dashboard</span>
</a>
<a href="/provider/add-surplus" class="nav-item active">
    <span class="nav-icon">◉</span>
    <span>Add Surplus</span>
</a>
<a href="/provider/events" class="nav-item">
    <span class="nav-icon">☰</span>
    <span>My Events</span>
</a>
<a href="/provider/allocations" class="nav-item">
    <span class="nav-icon">⇄</span>
    <span>Allocations</span>
</a>
<a href="/provider/reviews" class="nav-item">
    <span class="nav-icon">★</span>
    <span>Reviews</span>
</a>

<div class="sidebar-divider"></div>

<a href="/logout" class="nav-item logout-item">
    <span class="nav-icon">↩</span>
    <span>Logout</span>
</a>
{% endblock %}

{% block page_title %}
Add Surplus Food
{% endblock %}

{% block content %}

<div class="two-column-grid">
    <div class="card">
        <div class="section-header">
            <h3>Submit Surplus Batch</h3>
            <span class="muted">Fill accurate details for better matching</span>
        </div>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label>Event Name</label>
                <input type="text" name="event_name" placeholder="Wedding - 12 June" required>
                <div class="form-help">Use a short, recognizable event label.</div>
            </div>

            <div class="form-group">
                <label>Provider Name</label>
                <input type="text" name="provider_name" placeholder="Your organization name">
            </div>

            <div class="form-group">
                <label>Mahal Name</label>
                <input type="text" name="mahal_name" placeholder="e.g., Sri Lakshmi Mahal" required>
                <div class="form-help">This name is shown to receivers for pickup.</div>
            </div>

            <div class="form-group">
                <label>Food Type</label>
                <input type="text" name="food_type" placeholder="Rice, Curry, Sweets..." required>
                <div class="form-help">Mention key items to help NGOs prioritize pickup.</div>
            </div>

            <div class="form-group">
                <label>Quantity (kg)</label>
                <input type="number" step="0.1" name="quantity_kg" placeholder="e.g., 120" required>
            </div>

            <div class="form-group">
                <label>Distance (km)</label>
                <input type="number" step="0.1" name="distance_km" placeholder="e.g., 4.2">
            </div>

            <div class="form-group">
                <label>Mahal Location</label>
                <input type="text" name="mahal_location" id="provider_location" list="provider_location_suggestions" placeholder="Type exact area/address of the mahal" required>
                <datalist id="provider_location_suggestions"></datalist>
                <div class="form-help">Type at least 3 letters and select a suggested locality.</div>
            </div>

            <div class="form-group">
                <label>Estimated Expiry</label>
                <input type="text" name="estimated_expiry" placeholder="e.g., 3 hours">
            </div>

            <div class="form-group">
                <label>Food Photo</label>
                <input type="file" name="food_photo" accept=".png,.jpg,.jpeg,.webp" required>
            </div>

            <button class="auth-button">Submit Surplus</button>
        </form>
    </div>

    <div class="card">
        <div class="section-header">
            <h3>Recent Submissions</h3>
            <span class="muted">Today and yesterday</span>
        </div>
        <table class="data-table compact">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Mahal</th>
                    <th>Qty</th>
                    <th>Status</th>
                    <th class="no-sort">Action</th>
                </tr>
            </thead>
            <tbody>
                {% if recent_surplus %}
                    {% for item in recent_surplus %}
                    <tr>
                        <td>{{ item.event_name }}</td>
                        <td>{{ item.mahal_name or '-' }}</td>
                        <td>{{ item.quantity if item.quantity is not none else item.quantity_kg }} kg</td>
                        <td>
                            {% if item.status == "available" %}
                                <span class="status completed">Available</span>
                            {% elif item.status == "pending" %}
                                <span class="status active">Pending Ready</span>
                            {% else %}
                                <span class="status active">{{ item.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.status == 'pending' %}
                                <form method="POST" action="{{ url_for('provider.provider_mark_surplus_ready', surplus_id=item.id) }}" class="inline-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn-link">Mark Ready</button>
                                </form>
                            {% else %}
                                <span class="muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5">No submissions yet.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(() => {
    const input = document.getElementById('provider_location');
    const list = document.getElementById('provider_location_suggestions');
    if (!input || !list) return;

    let timer = null;
    input.addEventListener('input', () => {
        clearTimeout(timer);
        const query = input.value.trim();
        if (query.length < 3) return;

        timer = setTimeout(async () => {
            const response = await fetch(`/location/suggest?q=${encodeURIComponent(query)}`);
            if (!response.ok) return;
            const data = await response.json();
            list.innerHTML = '';
            (data.suggestions || []).forEach((label) => {
                const option = document.createElement('option');
                option.value = label;
                list.appendChild(option);
            });
        }, 300);
    });
})();
</script>
{% endblock %}